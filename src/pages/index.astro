---
import Base from "~/layouts/Base.astro";
import Section from "~/components/Section.astro";
import ProjectCard from "~/components/ProjectCard.astro";
import MotionReveal from "~/components/MotionReveal";
import HeroStatic from "~/components/HeroStatic.astro";
import HeroVisualStatic from "~/components/HeroVisualStatic.astro";
import LogoMarquee from "~/components/LogoMarquee.astro";
import TiltingCard from "~/components/TiltingCard";
import PillImageReveal from "~/components/PillImageReveal.astro";
import ProcessStepCard from "~/components/ProcessStepCard";
import FounderSection from "~/components/FounderSection.astro";
import IntroSection from "~/components/IntroSection.astro";
import WaveDivider from "~/components/WaveDivider.astro";
import ScrollCue from "~/components/ScrollCue.astro";
import { getCollection } from "astro:content";
import { SITE } from "~/lib/seo";

const projects = await getCollection("projects", ({ data }) => data.featured);
const featured = projects.sort((a, b) => (a.data.date > b.data.date ? -1 : 1)).slice(0, 4);
const servicesCollection = await getCollection("services");
const testimonials = await getCollection("testimonials");
const marqueeLogos = [
  { prefix: "EdTech", label: "Admin Panel SMA" },
  { prefix: "LMS", label: "Classroom Informatika" },
  { prefix: "Live Learning", label: "GEMA SMAWA" },
  { prefix: "Retail", label: "Kios POS" },
  { prefix: "Enterprise", label: "Buroq Admin Panel" },
  { prefix: "Fintech", label: "Elysian Bank" },
  { prefix: "Streaming", label: "Nebula TV" },
  { prefix: "Ecommerce", label: "Aurora Commerce" },
  { prefix: "Health", label: "Pulse Health" },
];
const impactHighlights = [
  {
    title: "Sistem manajemen sekolah terpusat untuk SMA",
    description:
      "Admin Panel SMA menggabungkan TypeScript dan React untuk mencatat kehadiran dan nilai akademik secara real-time, mengurangi pekerjaan manual administrasi dengan interface responsif.",
    metric: "Data aman & terpusat",
    icon: "üéì",
    category: "education" as const,
  },
  {
    title: "Platform pembelajaran digital komprehensif",
    description:
      "GEMA SMAWA mengintegrasikan manajemen siswa, konten tutorial, dan interaksi real-time dengan Next.js 15 dan LiveKit untuk meningkatkan engagement siswa dalam satu ekosistem terpadu.",
    metric: "Engagement lebih tinggi",
    icon: "üì°",
    category: "education" as const,
  },
  {
    title: "Sistem kasir digital untuk retail modern",
    description:
      "Kios POS menyediakan platform Point of Sale berbasis web dengan TypeScript, memproses transaksi kurang dari 3 detik per item dengan cloud-ready deployment di Vercel.",
    metric: "<3s per transaksi",
    icon: "üõí",
    category: "retail" as const,
  },
  {
    title: "Dashboard enterprise dengan integrasi lengkap",
    description:
      "Buroq Admin Panel menggabungkan React 18+, TypeScript, dan Vite untuk centralized management system dengan Google Maps integration dan WhatsApp Business automation.",
    metric: "Type-safe & modular",
    icon: "‚öôÔ∏è",
    category: "enterprise" as const,
  },
];
const processSteps = [
  {
    step: "01",
    title: "Analisis & Perencanaan",
    description:
      "Mengidentifikasi kebutuhan bisnis, merancang arsitektur sistem, dan menentukan tech stack optimal (React/Next.js, Node.js/Golang, PostgreSQL) sebelum eksekusi.",
  },
  {
    step: "02",
    title: "Desain API & Database",
    description:
      "Merancang RESTful API, skema database relasional, dan struktur data yang scalable dengan fokus pada efisiensi query dan integritas data.",
  },
  {
    step: "03",
    title: "Development Full-Stack",
    description:
      "Implementasi backend (Node.js/Golang) dan frontend (React/Next.js) dengan TypeScript, state management modern, dan integrasi real-time menggunakan WebSocket/Redis.",
  },
  {
    step: "04",
    title: "Deployment & Maintenance",
    description:
      "Deploy ke production (Vercel, Railway, Supabase), setup monitoring, optimisasi performa, dan dokumentasi teknis untuk kemudahan maintenance jangka panjang.",
  },
];
const primaryService = servicesCollection[0]?.data;

const homePageSchema = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  name: SITE.title,
  description: SITE.description,
  url: SITE.url,
};
---

<Base structuredData={homePageSchema}>
  <section class="hero-section relative overflow-hidden">
    <!-- Parallax Background Layers -->
    <div
      aria-hidden="true"
      class="parallax-layer absolute inset-0 -z-10 bg-gradient-to-br from-accent/10 via-transparent to-transparent"
      data-speed="0.5"
    >
    </div>
    <div
      aria-hidden="true"
      class="parallax-layer absolute left-1/2 top-12 -z-10 h-72 w-72 -translate-x-1/2 rounded-full bg-accent/15 blur-[120px]"
      data-speed="0.3"
    >
    </div>
    <!-- Additional decorative parallax elements -->
    <div
      aria-hidden="true"
      class="parallax-layer absolute right-20 top-32 -z-10 h-48 w-48 rounded-full bg-success/5 blur-[100px]"
      data-speed="0.7"
    >
    </div>
    <div
      aria-hidden="true"
      class="parallax-layer absolute left-20 bottom-20 -z-10 h-64 w-64 rounded-full bg-accent/8 blur-[110px]"
      data-speed="0.4"
    >
    </div>

    <div class="mx-auto max-w-6xl px-6 pb-32 pt-36">
      <div class="grid gap-16 md:grid-cols-[minmax(0,1fr)_minmax(280px,0.9fr)] md:items-center">
        <HeroStatic />
        <HeroVisualStatic />
      </div>
    </div>
  </section>

  <section class="mx-auto max-w-6xl px-6 pb-16">
    <p class="text-xs uppercase tracking-[0.32em] text-accent/80">Kolaborasi & karya</p>
    <h2 class="mt-2 text-sm text-text2">
      Produk yang saya bangun membantu pendidikan, ritel, dan ekosistem digital lainnya melaju lebih
      cepat.
    </h2>
    <div class="mt-6">
      <LogoMarquee items={marqueeLogos} duration={26} />
    </div>
    <ScrollCue text="Scroll untuk mengetahui lebih lanjut" />
  </section>

  <WaveDivider variant="top" color="accent" opacity={0.08} />
  <IntroSection />
  <WaveDivider variant="bottom" color="accent" opacity={0.08} />

  <WaveDivider variant="top" color="accent" opacity={0.06} />
  <section class="impact-section relative mx-auto max-w-6xl px-6 pb-24 pt-16">
    <!-- Subtle background pattern -->
    <div
      class="absolute inset-0 -z-10 bg-gradient-to-br from-accent/[0.02] via-transparent to-success/[0.02]"
      aria-hidden="true"
    >
    </div>

    <div class="mx-auto max-w-4xl text-center">
      <p class="text-xs uppercase tracking-[0.32em] text-accent/80">Dampak produk</p>
      
      <p
        class="mt-5 mx-auto max-w-[650px] text-sm leading-relaxed tracking-wide text-text2 md:text-base"
        style="letter-spacing: 0.01em;"
      >
        Setiap kartu merangkum bagaimana pendekatan detail‚Äîdari kontrak data bersama hingga fallback
        koneksi‚Äîmendorong tim shipping fitur lebih percaya diri.
      </p>
    </div>

    <!-- Grid 2 kolom di desktop untuk spesialisasi box -->
    <div class="impact-grid mt-12 grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2">
      {impactHighlights.map((card, index) => <TiltingCard client:idle {...card} index={index} />)}
    </div>

    <!-- CTA to view all projects -->
    <div class="mt-12 text-center">
      <a
        href="/projects"
        class="group inline-flex items-center gap-2 text-sm font-medium text-accent transition-all duration-200 hover:gap-3 hover:text-accent/80"
      >
        <span>Lihat Semua Proyek</span>
        <svg
          class="h-4 w-4 transition-transform duration-200 group-hover:translate-x-1"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
        </svg>
      </a>
    </div>
  </section>

  <WaveDivider variant="top" color="accent" opacity={0.05} />
  <Section
    id="projects"
    eyebrow="Portfolio"
    title="Proyek Unggulan"
    description="Berikut adalah beberapa proyek yang telah saya kerjakan ‚Äî dari sistem backend yang kokoh hingga antarmuka yang intuitif."
  >
    <!-- Enhanced title with gradient -->
    <style>
      #projects h2 {
        background: linear-gradient(
          135deg,
          rgb(var(--color-text)) 0%,
          rgb(var(--color-accent)) 100%
        );
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
    </style>

    <div class="grid gap-10 md:grid-cols-2">
      {
        featured.map(({ data, slug }, index) => (
          <ProjectCard
            project={data}
            slug={slug}
            revealDelay={index * 0.15}
            projectNumber={index + 1}
          />
        ))
      }
    </div>
  </Section>
  <WaveDivider variant="bottom" color="accent" opacity={0.05} />

  {
    processSteps.length > 0 && (
      <>
        <WaveDivider variant="top" color="accent" opacity={0.06} />
        <section class="process-section relative mx-auto max-w-6xl px-6 py-28">
          {/* Subtle background gradient */}
          <div
            class="absolute inset-0 -z-10 bg-gradient-to-b from-accent/[0.02] via-transparent to-transparent"
            aria-hidden="true"
          />

          {/* Section Header */}
          <div class="mx-auto max-w-4xl text-center">
            <p class="text-xs uppercase tracking-[0.32em] text-accent/80">Layanan</p>
            <h2 class="mt-3 mx-auto max-w-3xl font-heading text-[1.9rem] font-semibold leading-tight text-text md:text-[2.35rem]">
              <span class="bg-gradient-to-r from-text to-accent bg-clip-text text-transparent">
                Cara saya membantu tim Anda
              </span>
            </h2>
            <p class="mt-5 mx-auto max-w-[700px] text-sm leading-relaxed text-text2 md:text-base">
              {primaryService?.description ??
                "Kerangka empat langkah yang menyatukan riset, prototyping, dan implementasi hingga siap diluncurkan."}
            </p>
            <p class="mt-4 text-sm italic text-text2/80">
              Metode kolaborasi ini dirancang agar tim Anda mendapatkan hasil maksimal tanpa
              kehilangan fleksibilitas.
            </p>
          </div>

          {/* Progress Indicator */}
          <div class="progress-dots mt-12 flex justify-center gap-3">
            {[0, 1, 2, 3].map((i) => (
              <div
                class="progress-dot h-2 w-2 rounded-full bg-accent/20 transition-all duration-500"
                data-step={i}
              />
            ))}
          </div>

          {/* Process Cards Grid */}
          <div class="process-grid relative mt-12">
            {/* Desktop Grid */}
            <div class="hidden gap-8 md:grid md:grid-cols-2 xl:grid-cols-4">
              {processSteps.map((step, index) => (
                <ProcessStepCard client:visible {...step} index={index} />
              ))}
            </div>

            {/* Mobile Carousel */}
            <div class="mobile-carousel md:hidden">
              <div class="carousel-container flex gap-6 overflow-x-auto pb-8 snap-x snap-mandatory scrollbar-hide">
                {processSteps.map((step, index) => (
                  <div class="carousel-item min-w-[85vw] snap-center">
                    <ProcessStepCard client:visible {...step} index={index} />
                  </div>
                ))}
              </div>

              {/* Scroll hint */}
              <p class="mt-4 text-center text-xs text-text2/60">
                ‚Üê Geser untuk melihat langkah berikutnya ‚Üí
              </p>
            </div>
          </div>
        </section>
        <WaveDivider variant="bottom" color="accent" opacity={0.06} />
      </>
    )
  }

  <FounderSection />

  {
    testimonials.length > 0 && (
      <Section
        eyebrow="Testimoni"
        title="Suara kolaborator"
        description="Rekan kerja dan klien tentang dampak kolaborasi kami."
      >
        <div class="testimonials-grid grid gap-12 md:grid-cols-2 md:gap-16">
          {testimonials.map(({ data }, index) => (
            <MotionReveal
              client:visible
              delay={index * 0.15}
              className={`h-full ${
                index % 2 === 1 ? "md:border-l md:border-[#E2E8F0] md:pl-12" : ""
              }`}
            >
              <div class="testimonial-card group relative flex h-full flex-col justify-between gap-8 rounded-2xl border border-transparent p-8 transition-all duration-500 hover:-translate-y-1 hover:border-accent/10 hover:bg-accent/[0.02] hover:shadow-lg hover:shadow-accent/5">
                {/* Large quote background */}
                <div
                  class="quote-bg pointer-events-none absolute left-4 top-4 text-[120px] leading-none text-divider/[0.08] transition-all duration-500 group-hover:scale-110 group-hover:text-accent/[0.12]"
                  aria-hidden="true"
                >
                  "
                </div>

                {/* Quote text */}
                <div class="relative z-10">
                  <p class="text-base italic leading-[1.8] text-text/90 md:text-lg">
                    "{data.quote}"
                  </p>
                </div>

                {/* Author info */}
                <div class="relative z-10 flex items-center gap-4">
                  {/* Avatar or Initial */}
                  {data.avatar ? (
                    <PillImageReveal
                      src={data.avatar}
                      alt={data.name}
                      width={56}
                      height={56}
                      class="h-14 w-14 flex-shrink-0"
                    />
                  ) : (
                    <div class="flex h-14 w-14 flex-shrink-0 items-center justify-center rounded-full bg-accent/10 font-heading text-xl font-semibold text-accent">
                      {data.name.charAt(0)}
                    </div>
                  )}

                  <div>
                    <span class="block font-heading text-base font-medium text-text">
                      {data.name}
                    </span>
                    <span class="block text-xs uppercase tracking-[0.28em] text-text2">
                      {data.role}
                    </span>
                  </div>
                </div>
              </div>
            </MotionReveal>
          ))}
        </div>
      </Section>
    )
  }
</Base>

<style>
  .parallax-layer {
    position: absolute;
    inset: 0;
    will-change: transform;
  }

  @media (prefers-reduced-motion: reduce) {
    .parallax-layer {
      transform: none !important;
    }
  }

  /* Mobile Carousel Styles */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  .carousel-container {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
  }

  /* Progress Dots Animation */
  .progress-dot {
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .progress-dot.active {
    background: rgb(var(--color-accent));
    transform: scale(1.5);
  }

  /* Connector Lines Enhancement */
  @media (min-width: 1280px) {
    .process-grid::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(
        to right,
        transparent,
        rgba(var(--color-accent), 0.1) 10%,
        rgba(var(--color-accent), 0.1) 90%,
        transparent
      );
      z-index: -1;
    }
  }
</style>

<script>
  function initParallax() {
    const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    if (prefersReducedMotion) return;

    const parallaxLayers = document.querySelectorAll(".parallax-layer");

    if (!parallaxLayers.length) return;

    let ticking = false;

    function updateParallax() {
      const scrollY = window.scrollY;

      parallaxLayers.forEach((layer) => {
        const speed = parseFloat(layer.getAttribute("data-speed") || "0");
        const yPos = -(scrollY * speed);
        layer.style.transform = `translateY(${yPos}px)`;
      });

      ticking = false;
    }

    function requestTick() {
      if (!ticking) {
        requestAnimationFrame(updateParallax);
        ticking = true;
      }
    }

    window.addEventListener("scroll", requestTick, { passive: true });

    // Initial update
    updateParallax();
  }

  // Initialize on page load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initParallax);
  } else {
    initParallax();
  }

  // Process Section Progress Indicator
  function initProcessProgress() {
    const progressDots = document.querySelectorAll(".progress-dot");
    const processCards = document.querySelectorAll('.process-grid [class*="ProcessStepCard"]');
    const carousel = document.querySelector(".carousel-container");

    if (!progressDots.length) return;

    // Desktop: Activate dots based on scroll position
    if (!carousel) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
              const index = Array.from(processCards).indexOf(entry.target);
              if (index >= 0) {
                progressDots.forEach((dot, i) => {
                  if (i <= index) {
                    dot.classList.add("active");
                  } else {
                    dot.classList.remove("active");
                  }
                });
              }
            }
          });
        },
        {
          threshold: [0.5],
          rootMargin: "-100px 0px",
        }
      );

      processCards.forEach((card) => observer.observe(card));
    }

    // Mobile: Track carousel scroll
    if (carousel) {
      const updateCarouselProgress = () => {
        const scrollLeft = carousel.scrollLeft;
        const itemWidth = carousel.scrollWidth / 4;
        const activeIndex = Math.round(scrollLeft / itemWidth);

        progressDots.forEach((dot, i) => {
          if (i === activeIndex) {
            dot.classList.add("active");
          } else {
            dot.classList.remove("active");
          }
        });
      };

      carousel.addEventListener("scroll", updateCarouselProgress, { passive: true });
      updateCarouselProgress(); // Initial state
    }
  }

  // Initialize process progress
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initProcessProgress);
  } else {
    initProcessProgress();
  }
</script>
