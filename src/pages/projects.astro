---
import Base from "~/layouts/Base.astro";
import { getCollection } from "astro:content";
import CTAButton from "~/components/CTAButton";
import WaveDivider from "~/components/WaveDivider.astro";
import { SITE } from "~/lib/seo";

const projects = (await getCollection("projects", ({ data }) => data.featured)).sort((a, b) =>
  a.data.date > b.data.date ? -1 : 1
);
const stacks = Array.from(new Set(projects.flatMap((project) => project.data.stack))).sort();
const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  name: "Portofolio proyek Mohammad Noor Wahid",
  description: "Daftar studi kasus lengkap yang dikurasi berdasarkan stack dan hasil bisnis.",
  url: `${SITE.url}/projects`,
};
---

<Base
  title="Proyek Mohammad Noor Wahid"
  description="Rangkuman studi kasus lengkap beserta proses, dampak, dan peran saya dalam tiap proyek."
  structuredData={structuredData}
  breadcrumbs={[{ name: "Proyek", url: "/projects" }]}
>
  <WaveDivider variant="top" color="accent" opacity={0.06} />
  <section class="mx-auto max-w-6xl px-6 pb-24 pt-28">
    <header class="space-y-4">
      <p class="text-xs uppercase tracking-[0.3em] text-accent">Studi kasus</p>
      <h1 class="font-heading text-4xl text-text">Proyek terkurasi</h1>
      <p class="max-w-2xl text-base text-text2">
        Filter berdasarkan stack untuk menemukan karya relevan. Navigasi kartu dapat menggunakan
        tombol panah, Enter untuk membuka, dan Escape untuk kembali ke filter.
      </p>
    </header>
    <div class="mt-10 flex flex-wrap items-center gap-3" id="filter-bar">
      <button class="focus-outline filter-chip" data-filter="all" type="button">Semua</button>
      {
        stacks.map((stack) => (
          <button class="focus-outline filter-chip" data-filter={stack} type="button">
            {stack}
          </button>
        ))
      }
    </div>
    <div class="projects-grid mt-12 grid gap-8 sm:grid-cols-2">
      {
        projects.map(({ data, slug }) => {
          // Assign category based on stack
          let category = "web";
          let categoryIcon = "üåê";
          let categoryColor = "accent";

          if (data.stack.includes("AI") || data.stack.includes("Python")) {
            category = "ai";
            categoryIcon = "ü§ñ";
            categoryColor = "success";
          } else if (data.stack.includes("EdTech") || data.stack.includes("Education")) {
            category = "education";
            categoryIcon = "üìö";
            categoryColor = "warning";
          } else if (data.stack.includes("E-commerce") || data.stack.includes("POS")) {
            category = "commerce";
            categoryIcon = "üõí";
            categoryColor = "info";
          }

          return (
            <article
              class="project-card group grid gap-4 rounded-2xl border border-divider/40 bg-surface/80 p-6 shadow-soft transition-all duration-300 hover:-translate-y-1 hover:border-accent/30 hover:shadow-medium focus:outline-none focus-visible:ring-2 focus-visible:ring-accent"
              tabindex="0"
              data-stack={data.stack.join(",")}
              data-category={category}
            >
              <div class="relative overflow-hidden rounded-xl">
                <div
                  class={`category-badge absolute left-3 top-3 z-10 flex items-center gap-1.5 rounded-full bg-${categoryColor}/90 px-3 py-1.5 text-xs font-medium text-white backdrop-blur-sm`}
                >
                  <span>{categoryIcon}</span>
                  <span class="capitalize">{category}</span>
                </div>
                <img
                  src={data.cover}
                  loading="lazy"
                  decoding="async"
                  alt={`Cuplikan proyek ${data.title}`}
                  class="h-48 w-full rounded-xl object-cover transition-transform duration-500 group-hover:scale-105"
                />
              </div>
              <div class="space-y-2">
                <h2 class="project-title font-heading text-2xl text-text transition-colors duration-200 group-hover:text-accent">
                  {data.title}
                </h2>
                <p class="text-sm text-text2">{data.problem}</p>
                <p class="text-sm text-success">{data.result}</p>
              </div>
              <CTAButton client:load href={`/project/${slug}`} variant="ghost">
                Lihat studi kasus
              </CTAButton>
            </article>
          );
        })
      }
    </div>
  </section>
  <script>
    const chips = document.querySelectorAll<HTMLButtonElement>(".filter-chip");
    const cards = Array.from(document.querySelectorAll<HTMLElement>(".project-card"));
    let active = "all";

    function updateFilter(target: string) {
      active = target;
      chips.forEach((chip) => {
        chip.classList.toggle("bg-accent", chip.dataset.filter === active);
        chip.classList.toggle("text-bg", chip.dataset.filter === active);
        chip.classList.toggle("border", chip.dataset.filter !== active);
        chip.classList.toggle("border-divider/60", chip.dataset.filter !== active);
        chip.setAttribute("aria-pressed", chip.dataset.filter === active ? "true" : "false");
      });
      cards.forEach((card) => {
        const stack = card.dataset.stack?.split(",") ?? [];
        const visible = active === "all" || stack.includes(active);
        card.style.display = visible ? "grid" : "none";
      });
    }

    chips.forEach((chip) => {
      chip.addEventListener("click", () => updateFilter(chip.dataset.filter ?? "all"));
      chip.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          updateFilter(chip.dataset.filter ?? "all");
        }
        if (event.key === "ArrowRight" || event.key === "ArrowLeft") {
          event.preventDefault();
          const chipsArray = Array.from(chips);
          const currentIndex = chipsArray.indexOf(chip);
          const nextIndex = event.key === "ArrowRight" ? currentIndex + 1 : currentIndex - 1;
          const targetChip = chipsArray[(nextIndex + chipsArray.length) % chipsArray.length];
          targetChip.focus();
        }
      });
    });

    updateFilter("all");

    const grid = document.querySelector<HTMLElement>(".projects-grid");
    grid?.addEventListener("keydown", (event) => {
      const focusable = cards.filter((card) => card.style.display !== "none");
      const currentIndex = focusable.indexOf(document.activeElement as HTMLElement);
      if (currentIndex === -1) return;
      const columns = window.innerWidth >= 640 ? 2 : 1;
      if (event.key === "ArrowRight") {
        event.preventDefault();
        focusable[(currentIndex + 1) % focusable.length]?.focus();
      } else if (event.key === "ArrowLeft") {
        event.preventDefault();
        focusable[(currentIndex - 1 + focusable.length) % focusable.length]?.focus();
      } else if (event.key === "ArrowDown") {
        event.preventDefault();
        focusable[Math.min(currentIndex + columns, focusable.length - 1)]?.focus();
      } else if (event.key === "ArrowUp") {
        event.preventDefault();
        focusable[Math.max(currentIndex - columns, 0)]?.focus();
      } else if (event.key === "Escape") {
        event.preventDefault();
        document.querySelector<HTMLButtonElement>("#filter-bar button")?.focus();
      }
    });
  </script>
  <style>
    .filter-chip {
      border-radius: 999px;
      border: 1px solid rgba(var(--color-divider), 0.6);
      background: rgba(var(--color-surface), 0.9);
      color: rgb(var(--color-text-muted));
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      transition: all 0.2s ease;
    }
    .filter-chip:hover {
      color: rgb(var(--color-text));
      border-color: rgba(var(--color-accent), 0.35);
    }

    /* Category badges with custom colors */
    .category-badge {
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    [data-category="ai"] .category-badge {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    }

    [data-category="education"] .category-badge {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
    }

    [data-category="commerce"] .category-badge {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
    }

    [data-category="web"] .category-badge {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
    }

    /* Project title hover underline effect */
    .project-title {
      position: relative;
      display: inline-block;
    }

    .project-title::after {
      content: "";
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 2px;
      background: rgb(var(--color-accent));
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .project-card:hover .project-title::after {
      width: 100%;
    }

    /* Fade animation on card hover */
    @media (prefers-reduced-motion: no-preference) {
      .project-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
    }
  </style>
</Base>
