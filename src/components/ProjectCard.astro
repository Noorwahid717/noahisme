---
import MotionReveal from "./MotionReveal";
import CTAButton from "./CTAButton";

interface ProjectFrontmatter {
  title: string;
  stack: string[];
  problem: string;
  result: string;
  cover: string;
  role: string;
  impact?: string;
  subtitle?: string;
  liveUrl?: string;
}

interface Props {
  project: ProjectFrontmatter;
  slug: string;
  revealDelay?: number;
  projectNumber?: number;
}

const { project, slug, revealDelay = 0, projectNumber } = Astro.props;

// Stack icon mapping
const stackIcons: Record<string, string> = {
  React: "âš›ï¸",
  "Next.js": "â–²",
  TypeScript: "ðŸ”·",
  Prisma: "ðŸ§©",
  PostgreSQL: "ðŸ˜",
  Tailwind: "ðŸŽ¨",
  "Node.js": "ðŸŸ¢",
  Golang: "ðŸ¹",
  Python: "ðŸ",
  Vite: "âš¡",
  Supabase: "âš¡",
  Vercel: "â–²",
  Railway: "ðŸš‚",
  Docker: "ðŸ³",
};

// Stack category for color coding
const getStackCategory = (stack: string): "frontend" | "backend" | "tools" => {
  const frontendStacks = ["React", "Next.js", "TypeScript", "Tailwind", "Vite"];
  const backendStacks = ["Node.js", "Golang", "Python", "Prisma", "PostgreSQL"];

  if (frontendStacks.includes(stack)) return "frontend";
  if (backendStacks.includes(stack)) return "backend";
  return "tools";
};

const categoryColors = {
  frontend: "bg-blue-500/10 text-blue-600 border-blue-500/20",
  backend: "bg-purple-500/10 text-purple-600 border-purple-500/20",
  tools: "bg-gray-500/10 text-gray-600 border-gray-500/20",
};
---

<MotionReveal client:only="react" delay={revealDelay}>
  <article
    class="group relative grid gap-6 overflow-hidden rounded-2xl border border-divider/40 bg-surface/95 p-0 shadow-subtle transition-all duration-500 motion-safe:hover:-translate-y-2 motion-safe:hover:border-accent/40 motion-safe:hover:shadow-[0_20px_60px_rgba(0,0,0,0.3)]"
  >
    <!-- Project Number Badge -->
    {
      projectNumber && (
        <div class="absolute left-6 top-6 z-20 flex h-12 w-12 items-center justify-center rounded-full border-2 border-accent/30 bg-surface/95 backdrop-blur-sm">
          <span class="font-heading text-lg font-bold text-accent">
            {projectNumber.toString().padStart(2, "0")}
          </span>
        </div>
      )
    }

    <!-- Image with Device Frame & Overlay -->
    <div class="relative overflow-hidden bg-gradient-to-br from-bg/50 to-accent/5">
      <!-- Browser Bar Mockup -->
      <div
        class="absolute left-0 right-0 top-0 z-10 flex items-center gap-1.5 bg-surface/90 px-4 py-2.5 backdrop-blur-sm"
      >
        <div class="flex gap-1.5">
          <div class="h-2.5 w-2.5 rounded-full bg-red-400"></div>
          <div class="h-2.5 w-2.5 rounded-full bg-yellow-400"></div>
          <div class="h-2.5 w-2.5 rounded-full bg-green-400"></div>
        </div>
        <div class="ml-2 flex-1 rounded bg-bg/60 px-3 py-0.5 text-[10px] text-text2">
          {slug}.app
        </div>
      </div>

      <!-- Project Image -->
      <div class="relative mt-10 overflow-hidden">
        <img
          src={project.cover}
          alt={`Cuplikan proyek ${project.title}`}
          width="800"
          height="450"
          class="h-64 w-full object-cover object-top transition-transform duration-700 ease-out motion-safe:group-hover:scale-105"
          loading={revealDelay === 0 ? "eager" : "lazy"}
          decoding="async"
          fetchpriority={revealDelay === 0 ? "high" : "auto"}
        />

        <!-- Gradient Overlay -->
        <div
          class="absolute inset-0 bg-gradient-to-t from-surface/80 via-transparent to-transparent opacity-0 transition-opacity duration-500 group-hover:opacity-100"
        >
        </div>

        <!-- View Live Badge (on hover) -->
        {
          project.liveUrl && (
            <a
              href={project.liveUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="absolute bottom-4 right-4 flex items-center gap-2 rounded-full bg-accent px-4 py-2 text-xs font-medium text-white opacity-0 shadow-lg transition-all duration-300 group-hover:opacity-100 group-hover:translate-y-0 translate-y-2"
              onclick="event.stopPropagation()"
            >
              <span>View Live</span>
              <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                />
              </svg>
            </a>
          )
        }
      </div>
    </div>

    <!-- Content -->
    <div class="space-y-5 px-6 pb-6">
      <!-- Role Badge -->
      <div class="flex items-center gap-2">
        <span class="text-xs font-medium uppercase tracking-[0.2em] text-accent/80"
          >{project.role}</span
        >
      </div>

      <!-- Title & Subtitle -->
      <div class="space-y-2">
        <h3
          class="font-heading text-2xl font-semibold leading-tight text-text transition-colors duration-200 group-hover:text-accent"
        >
          {project.title}
        </h3>
        {project.subtitle && <p class="text-sm font-medium text-text2/80">{project.subtitle}</p>}
      </div>

      <!-- Stack Tags with Icons & Colors -->
      <div class="flex flex-wrap gap-2">
        {
          project.stack.map((stack: string, index: number) => {
            const category = getStackCategory(stack);
            const icon = stackIcons[stack] || "â€¢";
            return (
              <span
                class={`inline-flex items-center gap-1.5 rounded-full border px-3 py-1 text-xs font-medium transition-all duration-200 ${categoryColors[category]}`}
                style={`animation-delay: ${index * 50}ms`}
              >
                <span aria-hidden="true">{icon}</span>
                <span>{stack}</span>
              </span>
            );
          })
        }
      </div>

      <!-- CTAs -->
      <div class="flex flex-wrap items-center gap-3 pt-2">
        <CTAButton
          client:load
          href={`/project/${slug}`}
          variant="ghost"
          class="flex items-center gap-2"
        >
          <span>Lihat studi kasus</span>
          <svg
            class="h-4 w-4 transition-transform duration-200 group-hover:translate-x-1"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
          </svg>
        </CTAButton>

        {
          project.liveUrl && (
            <a
              href={project.liveUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="text-xs font-medium text-accent/70 transition-colors duration-200 hover:text-accent"
            >
              View live site â†’
            </a>
          )
        }
      </div>
    </div>
  </article>
</MotionReveal>
